type: team
name: generateStructureExp
skills:
  - type: function
    process: |
      const { readFile } = await import('node:fs/promises');

      const original = await readFile('./.aigne/doc-smith/output/document_structure.yaml', 'utf-8').catch(() => '');
      options.context.userContext.documentStructure = original;
      options.context.userContext.documentStructureWithLines = original.split("\n")
        .map((line, index) => `${index}: ${line}`).join("\n");
      return {};

  - type: team
    skills:
      - type: ai
        name: generate_structure
        instructions:
          - role: system
            url: ./system-prompt.md
          - role: user
            url: ./user-prompt.md
        afs:
          modules:
            - module: local-fs
              options:
                name: workspace
                localPath: .
                description: The target repository containing source code, documentation, and other files that serve as the data source for analyzing and generating the document structure
        output_schema:
          type: object
          properties:
            isStructurePerfect:
              type: boolean
              description: Indicates whether the current document structure is perfect and requires no further changes
            patches:
              type: array
              items:
                type: object
                properties:
                  start_line:
                    type: integer
                    description: The starting line number (0-based) in the original document_structure.yaml where the patch should be applied
                  end_line:
                    type: integer
                    description: The ending line number (0-based, exclusive) in the original document_structure.yaml. The range is [start_line, end_line). To insert at line N without deleting, use start_line=N, end_line=N.
                  replace:
                    type: string
                    description: The new content that will replace the lines from start_line to end_line in the original document_structure.yaml
                  delete:
                    type: boolean
                    description: Indicates whether the specified lines should be deleted (true) or replaced (false)
                  reason:
                    type: string
                    description: A Short explanation of why this patch is needed
                required: ["start_line", "end_line", "delete", "reason"]
              description: "A list of patches to update the document structure. Each patch modifies specific lines in the document_structure.yaml file."
          required:
            - isStructurePerfect

      - ./tools/apply_diff.mjs

    reflection:
      is_approved: isApproved
      max_iterations: 3
      return_last_on_max_iterations: true
      reviewer:
        type: ai
        name: check_document_structure
        instructions:
          - role: system
            url: ./reviewer-system-prompt.md
        output_schema:
          type: object
          properties:
            isApproved:
              type: boolean
              description: Indicates whether the proposed document structure changes are approved
            reviewComments:
              type: string
              description: Additional comments from the reviewer regarding the document structure changes
          required:
            - isApproved

  - ./tools/convert-structure-to-plan.mjs
